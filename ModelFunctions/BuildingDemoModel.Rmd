---
title: "Building the demographic model"
author: "Claire Powers"
date: "2024-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set-up
```{r start, message=TRUE, warning=TRUE, include=FALSE}
rm(list=ls())

# Packages
library(tidyverse)

# Plotting
theme_set(theme_bw(base_size=14))
stage.cols = c(seed="springgreen4",juv="blue3",flrg="magenta3")
place.cols = c(Cool ="#175D71" , Warm = "#98463C", Avg = "#D48B47")

# Constants
sizes = c(seed=1,juv=8,flrg=10)

# Functions 
source("ModelFunctions/ParamVals.R")
source("ModelFunctions/logit2prob.R")
source("ModelFunctions/survival_fun.R")
source("ModelFunctions/growth_fun.R")
source("ModelFunctions/subpop_mx_fun.R")
source("ModelFunctions/seednum_fun.R")
```

### Survival function
```{r basic_survival_fun}

# look at survival across a range of regional climate values
surv.clim = data.frame(clim = seq(-20,20,by=0.1),
                       seed=NA,
                       juv=NA,
                       flrg=NA)

for(i in 1:nrow(surv.clim)){
  
    surv_params$clim = surv.clim$clim[i]
    s.rates = do.call(survival_fun,surv_params)
    surv.clim[i,2:4]=s.rates
  
}

plot.df = pivot_longer(surv.clim,cols = !clim, names_to = "stage",values_to = "s.rate")

ggplot(plot.df,aes(x=clim,y=s.rate,color=stage))+
  geom_line(linewidth=1.5)+
  scale_color_manual(values=stage.cols) +scale_y_continuous(limits = c(0,1))+
  labs(title="Survival curves")

rm(i)

```

### Growth function
```{r basic_growth_fun}

# look at survival across a range of regional climate values
grow.clim = data.frame(clim = seq(-15,15,by=0.1),
                       seed=NA,
                       juv=NA)

for(i in 1:nrow(grow.clim)){
  
    growth_params$clim = grow.clim$clim[i]
    g.rates = do.call(growth_fun,growth_params)
    grow.clim[i,2:3]=g.rates
  
}

plot.df = pivot_longer(grow.clim,cols = !clim, names_to = "stage",values_to = "g.rate")
ggplot(plot.df,aes(x=clim,y=g.rate,color=stage))+
  geom_line(linewidth=1.5)+
  scale_color_manual(values=stage.cols,labels=c("juv to flrg","seed to juv")) + 
  scale_y_continuous(limits=c(0,1))+
  ggtitle("Growth curves")

rm(i)
```

### Finding seed # (to set F cell) based on magnitude and direction of aspect effect
```{r seednumbers}

seed_df <- expand.grid(aspect.effect = c(-1,1),
                       asp.mag = 20,
                       # clim = -40:45,
                       seeds=NA,
                       lam=NA)


for(i in 1:nrow(seed_df)){
  
  growth_params.i <- growth_params
  surv_params.i <- surv_params
  
  growth_params.i$asp.effect = surv_params.i$asp.effect = seed_df$aspect.effect[i]
  growth_params.i$asp.mag = surv_params.i$asp.mag = seed_df$asp.mag[i]

  surv.rates <- do.call(survival_fun,surv_params.i)
  
  surv_params.i$clim <- growth_params.i$clim <- seed_df$clim[i]
  
  
  # Get survival/growth matrix (seeds = 0 means no fecundity)
  sg.mx = subpop_mx_fun(surv_params = surv_params.i,growth_params = growth_params.i,seeds.in=0)
  
  # Run seednum_fun through optim function to fund the seed number that gets a lambda value of around 1.01
  seeds.optim = stats::optim(par = 100, fn = basic_seeds_fun, method = "L-BFGS-B", lower=0, upper=10000000, 
                             control = list(factr = 1e-15))
  
  # Save that seed number to the global environment
  seeds.i <- round(seeds.optim$par)
  seed_df$seeds[i] <- seeds.i 
  
  sg.mx[1,3] <- surv.rates["flrg"]*P.flr*seeds.i
  
  seed_df$lam <- Re(eigen(sg.mx)$values[1])

  rm(growth_params.i,surv_params.i,sg.mx,seeds.i,surv.rates)
  
  }

write_csv(seed_df,"ModelFunctions/fecundity.csv")
```


### VERSION 2: Finding seed # (to set F cell) based on magnitude and direction of aspect effect PLUS LONG TERM LAMBDA
```{r seednumbers}

seed_df <- expand.grid(asp.mag = seq(0,20,20),
                       clim.sd = seq(0,20,20),
                       seeds=NA)

n.subpops=2
asp.effects = c(-1,1)
burn.in = 50
sim.years = 500
years <- burn.in + sim.years
start.cells = F.rows = seq(1,n.subpops*3,by=3)


for(i in 1:nrow(seed_df)){
  
  # Get asp magnitude and climate SD for the current loop
  asp.mag.i <- seed_df$asp.mag[i]
  clim.sd.i <- seed_df$clim.sd[i]
  # Set Seeds # = 0 and x = 1
  x <- 1;seeds <- 0
    
  while(x>0.0005){
  
      annual.df <- data.frame(yr=1:years, lam=NA)
      
      growth_params.i <- growth_params
      surv_params.i <- surv_params
      growth_params.i$asp.mag <- surv_params.i$asp.mag <- asp.mag.i

      seeds = seeds + exp(asp.mag.i)
      
      for(yr in 1:years){
        
        clim.yr <- rnorm(1,sd=clim.sd.i)
        
        growth_params.i$clim <- surv_params.i$clim <- clim.yr
        
        # Initiate a full population MX for current year
        pop.mx <- matrix(data=0,nrow=n.subpops*3,ncol=n.subpops*3)
        
        # Build the full population mx
        for(n in 1:n.subpops){
      
          # Add subpop asp.effect to parameters
          surv_params.i$asp.effect <- growth_params.i$asp.effect <- asp.effects[n]
      
          # Create sub-population matrix
          subpop.mx = subpop_mx_fun(surv_params = surv_params.i,
                                    growth_params = growth_params.i,
                                    seeds.in = seeds)
          
          start.cell = start.cells[n]
          pop.mx[start.cell:(2+start.cell),start.cell:(2+start.cell)]=subpop.mx
          rm(subpop.mx)
        }
        
        lam <- Re(eigen(pop.mx)$values[1])
        annual.df$lam[yr] <- lam
      }
    
      annual.df <- filter(annual.df,yr>burn.in)
      lt.lam <- geoMean(annual.df$lam)
      x <- (1.005-lt.lam)^2
      print(seeds)
      }
  
  seed_df$seeds[i] <- seeds
  
  }

```


  
  # Run seednum_fun through optim function to fund the seed number that gets a lambda value of around 1.01
  seeds.optim = stats::optim(par = 1000, fn = complex_seeds_fun, asp.mag=asp.mag.i, clim.sd=asp.mag.i, years=(burn.in+years), method = "L-BFGS-B", lower=0, upper=10000000, 
                             control = list(factr = 1e-15))
  
  # Save that seed number to the global environment
  seeds.i <- round(seeds.optim$par)
  seed_df$seeds[i] <- seeds.i 

#### Look at growth fun across range of clim var, asp.eff, asp.mag ####
```{r more_growthFun}

growth_df = expand.grid(asp.effect = c(-1,1),
                        asp.mag = 20,
                        clim = rnorm(n=1000,sd=15),
                        seed = NA, juv = NA)

for(i in 1:nrow(growth_df)){

  growth_df[i,c('seed','juv')] = growth_fun(sizes = growth_params$sizes,
                 max.growth.rates = growth_params$max.growth.rates,
                 min.growth.rates = growth_params$min.growth.rates,
                 G_2 = growth_params$G_2,
                 G_3 = growth_params$G_3,
                 asp.mag = growth_df$asp.mag[i],
                 asp.effect = growth_df$asp.effect[i],
                 clim = growth_df$clim[i])

}

ggplot(growth_df,aes(x=clim,y=seed,color=as.factor(asp.effect)))+
  geom_line()+
  geom_vline(xintercept=0)+
  facet_wrap(~asp.mag)+
  theme_bw()+
  scale_y_continuous(limits = c(0,1))

ggplot(growth_df,aes(x=clim,y=juv,color=as.factor(asp.effect)))+
  geom_line()+
  geom_vline(xintercept=0)+
  facet_wrap(~asp.mag)+
  theme_bw()+
  scale_y_continuous(limits = c(0,1))

```


#### Look at survival fun across range of clim var, asp.eff, asp.mag ####
```{r more_survivalFun}

surv_df = expand.grid(asp.effect = c(-1,1),
                      asp.mag = 20,
                      clim = rnorm(n=1000,sd=15),
                      seed = NA, juv = NA,flrg=NA)

for(i in 1:nrow(surv_df)){

  surv_df[i,c('seed','juv',"flrg")] =
    survival_fun(sizes = surv_params$sizes,
                 max.survival.rates = surv_params$max.survival.rates,
                 min.survival.rates = surv_params$min.survival.rates,
                 S_2 = surv_params$S_2,
                 S_3 = surv_params$S_3,
                 asp.mag = surv_df$asp.mag[i],
                 asp.effect = surv_df$asp.effect[i],
                 clim = surv_df$clim[i])

}

surv_df = surv_df %>%
  mutate(place.name = case_when(asp.effect==-1~"Cool",
                                asp.effect==0~"Avg",
                                asp.effect==1~"Warm"))

ggplot(surv_df,aes(x=clim,y=seed,color=place.name))+
  geom_line()+
  geom_vline(xintercept=0)+
  facet_wrap(~asp.mag)+
  theme_bw()+
  scale_color_manual(values=place.cols)

ggplot(surv_df,aes(x=clim,y=juv,color=as.factor(asp.effect)))+
  geom_line()+
  geom_vline(xintercept=0)+
  facet_wrap(~asp.mag)+
  theme_bw()

ggplot(surv_df,aes(x=clim,y=flrg,color=as.factor(asp.effect)))+
  geom_line()+
  geom_vline(xintercept=0)+
  facet_wrap(~asp.mag)+
  theme_bw()

```


