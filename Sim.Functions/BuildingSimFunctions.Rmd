---
title: "Setting up the simulation functions"
author: "Claire Powers"
date: "2024-10-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set-up
```{r start}
rm(list=ls())

# Packages
library(tidyverse)
library(parallel)
library(doParallel)
library(foreach)
library(EnvStats)

# Functions & model parameters
source("Sim.Functions/moveMx_fun.R")
source("Sim.Functions/simfun_exp.R")
source("ModelFunctions/ParamVals.R")
source("ModelFunctions/subpop_mx_fun.R")
seeds_df <- read_csv("ModelFunctions/fecundity.csv")

# Sim. function inputs
burn.in.yrs <- 100
sim.yrs <- 500
asp.effects <- c(-1,1)
n.subpops <- length(asp.effects)
reps <- 5
clim.sds <- seq(0,20,by=4)
asp.mags <- seq(0,20,by=2)
```


## Exponential growth, symmetrical movement
#### Testing out the simplest version of simulation
```{r S1_setup}
# Things needed to run sim funciton line by line
# clim.sd <- 2
# asp.mag <- 2

## Creating all combinations of movement rates
subpop.names = LETTERS[1:n.subpops] # Name subpops with letters
move.rates = seq(0.1,0.2,by=0.1)
move.dirs = expand.grid(from=subpop.names,to=subpop.names) %>% # get all combos
  # Remove rows that imply no movement (A to A)
  filter(from!=to) %>% 
   # Concatenate
  mutate(col.names = paste0(from,"to",to)) %>% 
  # save last column as a vector
  arrange(col.names) %>% pull() 

# Create movement data.frame to loop over
move.rates.df = matrix(data=rep(move.rates,length(move.dirs)),ncol=length(move.dirs)) %>% # generate matrix with movement rates
  as.data.frame() %>% 
  # Make all combos of movement rates
  expand.grid() %>% 
  filter(if_all(starts_with("V"),~ .==V1)) ## This filters for symmetrical movement rates
names(move.rates.df)=move.dirs # rename columns to make movement direction clear
rm(subpop.names,move.dirs,move.rates) # remove extra things from env

#### Run S1 #####
cores = detectCores()
cl = makeCluster(cores/5)
registerDoParallel(cl = cl)

S1_out_df <- foreach(rep = 1:reps, .combine = rbind,.packages=c("tidyverse","EnvStats")) %:% 
  foreach(move.rates.row = 1:nrow(move.rates.df), .combine = rbind,.packages=c("tidyverse","EnvStats")) %:%
    foreach(clim.sd.i = clim.sds, .combine = rbind,.packages=c("tidyverse","EnvStats")) %:%
      foreach(asp.mag.i = asp.mags, .combine = rbind,.packages=c("tidyverse","EnvStats")) %dopar% {

        move.rates.i <- move.rates.df[move.rates.row,]
        
        ##### Create a movement matrix from the move.rates row
        move.mx.i = moveMx_fun(n.subpops,move.rates.i)
        
        # clim.sd.i = 10
        # asp.mag.i = 0
        
        df = simfun_exponential(burn.in.yrs=burn.in.yrs, sim.yrs=sim.yrs, n.subpops=n.subpops,asp.effects = asp.effects,
                            clim.sd=clim.sd.i, asp.mag=asp.mag.i, move.mx = move.mx.i)
        
        tmp.df = df %>%
          filter(year>burn.in.yrs) %>% # Filter out burn-in years. This could also happen within the function.
          summarise(clim.mean = mean(clim),
                    clim.var = var(clim),
                    pop.var = var(pop.lam),
                    lt.pop.lam = geoMean(pop.lam)) %>% 
          mutate(clim.sd = clim.sd.i,
                 asp.mag = asp.mag.i,
                 rep = rep) %>% 
          merge(.,move.rates.i)
        return(tmp.df)
      
        # rm(df,tmp.df,clim.sd.i,asp.mag.i,move.rate.i)
        
      }
stopCluster(cl)

write_csv(S1_out_df,paste0("Sim.Output/S1_ExpGrowth_SymMovement/S1_output_",round(Sys.time()),".csv"))
```

#### Plot S1 results
```{r}

S1_plot_df <- S1_out_df %>% 
  group_by(clim.sd,asp.mag,move.rate = AtoB) %>% 
  summarize(agg.pop.var = mean(pop.var),
            agg.lt.pop.lam = mean(lt.pop.lam))

ggplot(S1_plot_df,aes(x=clim.sd,y=asp.mag,z=agg.lt.pop.lam))+
  geom_contour_filled()+
  facet_wrap(~move.rate)

ggplot(S1_out_df,aes(x=clim.sd,y=lt.pop.lam,color=factor(asp.mag)))+
  geom_smooth()


clim.sd.i <- 10
asp.mag.i <- 20
move.rates.i <- move.rates.df[1,]
move.mx.i <- moveMx_fun(n.subpops,move.rates.i)
df = simfun_exponential(burn.in.yrs=burn.in.yrs, sim.yrs=sim.yrs, n.subpops=n.subpops, asp.effects = asp.effects,
                            clim.sd=clim.sd.i, asp.mag=asp.mag.i, move.mx = move.mx.i)

ggplot(filter(df,year>100),aes(x=year,y=pop.lam))+
  geom_point()

```

```{r}


```


